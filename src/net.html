<html>
    <head>
        <meta charset="utf-8">
        <title>Net Spliiter</title>    
        <link rel="stylesheet" type="text/css" href="style/main.css">
        <link rel="stylesheet" type="text/css" href="style/svg.css">
        <link rel="stylesheet" type="text/css" href="style/jquery.svg.css">

        <script src='https://code.jquery.com/jquery-2.1.3.min.js'></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r71/three.min.js"></script>
        <script src="js/svg/jquery.svg.min.js"></script>
        <script src='js/extension.js'></script>
        <script src="js/geometry.js"></script>
        <script src='js/ori.js'></script>
        <script src='js/net-spliiter.js'></script>

    </head>
    <body>        
        <div id="hint" class="center w400 h200 absolute-center">            
            <h1 class="margin4">Drop Net Here</h1> 
            <h3>Or Start With Following Nets</h3>
            <div id="models">                    
            </div>
        </div>

        <div id="title">
            Net-Splitter
        </div>

        <div id="frame" style="margin-top:30px">
            <table border="0" width="98%">
            <tr valign="center">
                <td rowspan="2" width="66%">
                    <div id="canvas" class="svg-canvas">
                    </div>
                </td>
                <td align="center">
                    <div id="subnet1" class="svg-canvas">                        
                    </div>
                    <button type="button" class="export-subnet" sub-net-id="1">Export</button>
                </td>
            </tr>
            <tr>
                <td align="center">
                    <div id="subnet2" class="svg-canvas">                        
                    </div>                    
                    <button type="button" class="export-subnet" sub-net-id="2">Export</button>
                </td>
            </tr>
            </table>
        </div>     

        <a id="hidden-link" class="hidden"></a>

        <div id="copyright" source="copyright.html">
        </div>

        <script type="text/javascript">
        var app_name = "Net-Splitter";
        var filename = '';
        var export_file_url = null;

        var highlighted_crease = null;

        var selected_cid = -1;
        var selected_crease = null;

        $("#canvas").svg();        
        $("#subnet1").svg();
        $("#subnet2").svg();
        var svg = $('#canvas').svg('get');
        var svg1 = $('#subnet1').svg('get');
        var svg2 = $('#subnet2').svg('get');
        var svg_cfg = null;

        svg.configure({id: 'raw-svg'}); 

        var raw_svg = $('#raw-svg').get(0);

        $('#title').hide();
        $('.svg-canvas').hide();
        $('.export-subnet').hide();

        var origami = new Origami.Model();

        function init_model()
        {
            // will be removed automatically, set it to null
            highlighted_crease = null;
            selected_crease = null;
            selected_cid = -1;
        }

        // draw the origami as svg
        function draw()
        {            
            svg_cfg = origami.drawSVG(svg);
            $("#canvas").show();
            resize();
        }

        function resize()
        {
            if(svg_cfg == null) return;

            var max_wdith = $(window).width() * 0.66;
            var max_height = ($(window).height() - 30) * 0.9;
            var max_scle = Math.min(max_wdith/svg_cfg.width, max_height/svg_cfg.height);
            var svg_width = svg_cfg.width*max_scle;

            svg.configure({id: 'raw-svg', width: svg_width}, false);            
        }

        $('div[source]').each(function(index){
            $(this).load($(this).attr('source'));
        });

        // load the model list
        $.getJSON("models/model-list.json", function(data, textStatus){            
        
            for(var i=0;i<data.models.length;++i)
            {
                var model = data.models[i];                    

                $("<button></button>").attr(
                    {
                        "type" : "button",
                        "model" : model.model_url,
                        "traj" : model.traj_url,
                        "model-name" : model.name
                    }
                ).html(model.name).appendTo($("#models"));
            }

            $("button").click(function() {                                
                model_url = $(this).attr("model");
                if(!model_url) return;

                traj_url = $(this).attr("traj");
                model_name = $(this).attr("model-name");

                init_model();
                $("#title").html(app_name + " - loading...");
                origami.load(model_url, null, function(){
                    $("#title").html(app_name + " - " + model_name)
                    .css("left", ($(document).width()-$("#title").width())/2).show();
                    $('#hint').hide();

                    filename = model_name;
                    draw();
                });
            });           
        });                            
    

        // export subnets
        $('.export-subnet').click(function(){
            var sub_net_id = $(this).attr('sub-net-id');
            var sub_net = sub_net_id == "1" ? svg1 : svg2;
            var text = sub_net.toSVG();
            var data = new Blob([text], {type : 'data:application/octet-stream'});
            if(export_file_url)
                window.URL.revokeObjectURL(export_file_url);
            export_file_url = window.URL.createObjectURL(data);
            
            var a = $('#hidden-link').get(0);            
            a.href = export_file_url;
            a.download = filename + '_sub_' + sub_net_id + '.svg';
            a.click();
        });

        $("html").on("dragover", function(event) {
            event.preventDefault();  
            event.stopPropagation();
            //$(this).addClass('dragging');
        });

        $("html").on("dragleave", function(event) {
            event.preventDefault();  
            event.stopPropagation();
            //$(this).removeClass('dragging');
        });

        $("html").on("drop", function(event) {
            event.preventDefault();  
            event.stopPropagation();
            var files = event.originalEvent.dataTransfer.files;
            if(!files) return;

            // only read the first file
            var file = files[0];
            if(file.name.indexOf('.json')==-1) return;
            var reader = new FileReader();

            reader.onload = function(e) {
                var text = reader.result;
                var obj = $.parseJSON(text);
                origami.build(obj);

                filename = file.name;

                $("#title").html(app_name + " - " + file.name)
                .css("left", ($(document).width()-$("#title").width())/2).show();
                $('#models').hide();

                init_model();
                draw();
            }

            reader.readAsText(file, 'UTF-8');
        });

        // mouse move event handler
        $('#canvas').mousemove(function(event) {            
            if(!origami) return;

            // Create an SVGPoint for future math
            var pt = raw_svg.createSVGPoint();
            pt.x = event.clientX; pt.y = event.clientY;
            var gt = pt.matrixTransform(raw_svg.getScreenCTM().inverse());

            if(highlighted_crease)
            {         
                svg.remove(highlighted_crease);
                highlighted_crease = null;
            }
            var cid = origami.getClosestCrease(gt);
            if(cid==-1) return;
            highlighted_crease = origami.highLightCrease(svg, cid);
        });

        $('#canvas').click(function(event) {
            if(!origami) return;

            // Create an SVGPoint for future math
            var pt = raw_svg.createSVGPoint();
            pt.x = event.clientX; pt.y = event.clientY;
            var gt = pt.matrixTransform(raw_svg.getScreenCTM().inverse());
            
            var cid = origami.getClosestCrease(gt);
            if(cid==-1) return;

            if(selected_crease)
            {         
                svg.remove(selected_crease);
                selected_crease = null;
            }
            
            selected_cid = cid;
            selected_crease = origami.highLightCrease(svg, selected_cid, true);

            // split the net
            origami.split(cid, svg1, svg2);

            // show subnet and export button
            $('.svg-canvas').show();
            $('.export-subnet').show();

        });

        $(window).resize(function() {            
            resize();
        });
        </script>    
    </body>
</html>